<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liveness Detection KYC with Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: auto;
        }
        #webcam {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            transform: scaleX(-1); /* Mirror effect */
        }
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 9999px;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        .status-dot.success { background-color: #4ade80; animation: none; } /* green-400 */
        .status-dot.fail { background-color: #f87171; animation: none; } /* red-400 */
        .status-dot.pending { background-color: #fbbf24; } /* amber-400 */
        .status-dot.recording { background-color: #ef4444; } /* red-500 */
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center mb-2">Video KYC Liveness Check</h1>
        <p class="text-gray-400 text-center mb-6">Powered by Gemini API</p>

        <div class="video-container bg-gray-900 rounded-lg mb-6 overflow-hidden">
            <video id="webcam" autoplay muted playsinline></video>
        </div>

        <div id="controls" class="text-center space-y-4">
            <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300 w-full md:w-auto">
                Start Verification
            </button>
            <button id="recordButton" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-all duration-300 w-full md:w-auto">
                Start Recording
            </button>
        </div>

        <div id="challenge-ui" class="hidden mt-6 text-center">
            <h2 class="text-xl font-semibold mb-2">Your Challenge:</h2>
            <p id="instruction" class="text-2xl font-bold text-amber-400 bg-gray-700 p-4 rounded-lg"></p>
            <div id="statusContainer" class="mt-4 p-4 bg-gray-900 rounded-lg">
                <div class="flex items-center justify-center space-x-3">
                    <span id="statusDot" class="status-dot pending"></span>
                    <span id="statusText" class="text-lg font-medium text-gray-300">Awaiting user action...</span>
                </div>
            </div>
            <div id="loader" class="hidden loader"></div>
        </div>

        <div id="result" class="hidden mt-6 text-center">
             <div id="successMessage" class="hidden p-4 bg-green-900 border border-green-700 rounded-lg">
                <h2 class="text-2xl font-bold text-green-300">✅ Verification Successful!</h2>
                <p class="text-green-400 mt-1">You appear to be a live user performing the action.</p>
            </div>
             <div id="failureMessage" class="hidden p-4 bg-red-900 border border-red-700 rounded-lg">
                <h2 class="text-2xl font-bold text-red-300">❌ Verification Failed</h2>
                <p id="failureReason" class="text-red-400 mt-1">Please try again and follow the instructions carefully.</p>
                <button id="retryButton" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all">Retry</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const video = document.getElementById('webcam');
        const startButton = document.getElementById('startButton');
        const recordButton = document.getElementById('recordButton');
        const challengeUI = document.getElementById('challenge-ui');
        const instructionText = document.getElementById('instruction');
        const statusContainer = document.getElementById('statusContainer');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const loader = document.getElementById('loader');
        const resultUI = document.getElementById('result');
        const successMessage = document.getElementById('successMessage');
        const failureMessage = document.getElementById('failureMessage');
        const failureReason = document.getElementById('failureReason');
        const retryButton = document.getElementById('retryButton');

        // --- State ---
        let stream;
        let mediaRecorder;
        let recordedChunks = [];
        let currentChallenge = null;
        let isRecording = false;

        // --- Challenges Definition ---
        const challenges = [
            'Show your left thumb and point your right index finger to your left eyebrow.',
            'Raise both of your hands and show your palms.',
            'Smile widely while pointing your left index finger at your chin.',
            'Close your right eye and show the back of your left hand.',
            'Tilt your head to the right and open your mouth.',
            'Make a fist with your right hand and show it to the camera.',
            'Touch your right shoulder with your left hand.',
            'Slowly nod your head up and down.',
            'Puff out your cheeks.',
            'Stick out your tongue.',
            'Cover your mouth with your right hand.',
            'Make a peace sign with your left hand.',
            'Look all the way to your left.'
        ];

        // --- Gemini API Call ---
        async function analyzeFrameWithGemini(base64Frame, challengeText) {
            // NOTE: The API key is intentionally left as an empty string.
            // The execution environment will automatically provide a valid key.
            const apiKey = "AIzaSyBT7HdajtSErs5qZdwx2JdLoqVXnIQ7RcM";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const prompt = `Analyze this image. The user was given the instruction: "${challengeText}". Determine if the person in the image is a real person correctly performing this action. Respond with only "Yes" or "No".`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Frame } }
                    ]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return text;
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "Error";
            }
        }

        // --- Core Functions ---
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
                await new Promise((resolve) => { video.onloadedmetadata = resolve; });
                return true;
            } catch (error) {
                console.error("Camera setup failed:", error);
                failureReason.textContent = "Could not access the camera. Please check permissions and try again.";
                showFailure();
                return false;
            }
        }

        function startVerification() {
            resetUI();
            startButton.classList.add('hidden');
            challengeUI.classList.remove('hidden');
            recordButton.classList.remove('hidden');
            
            currentChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            instructionText.textContent = currentChallenge;
            statusText.textContent = 'Ready to record.';
        }

        function startRecording() {
            if (!stream) return;
            isRecording = true;
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = processVideo;

            mediaRecorder.start();
            recordButton.textContent = 'Stop & Analyze';
            statusDot.className = 'status-dot recording';
            statusText.textContent = 'Recording... (3 seconds)';

            setTimeout(stopRecording, 3000); // Record for 3 seconds
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            recordButton.textContent = 'Analyzing...';
            recordButton.disabled = true;
            statusContainer.classList.add('hidden');
            loader.classList.remove('hidden');
        }

        async function processVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(blob);

            // Use a temporary video element to grab the last frame
            const tempVideo = document.createElement('video');
            tempVideo.src = videoUrl;

            tempVideo.onloadeddata = async () => {
                // Seek near the end of the video to get a good frame
                tempVideo.currentTime = tempVideo.duration * 0.95; 
            };
            
            tempVideo.onseeked = async () => {
                const canvas = document.createElement('canvas');
                canvas.width = tempVideo.videoWidth;
                canvas.height = tempVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                
                const base64Frame = canvas.toDataURL('image/jpeg').split(',')[1];
                
                const resultText = await analyzeFrameWithGemini(base64Frame, currentChallenge);

                loader.classList.add('hidden');
                challengeUI.classList.add('hidden');
                resultUI.classList.remove('hidden');

                if (resultText && resultText.trim().toLowerCase().includes('yes')) {
                    successMessage.classList.remove('hidden');
                } else {
                    failureReason.textContent = resultText === "Error" ? "Analysis failed. Please try again." : "Liveness check failed. The action was not detected correctly.";
                    failureMessage.classList.remove('hidden');
                }
                URL.revokeObjectURL(videoUrl); // Clean up memory
            };
        }

        // --- UI & State Management ---
        function showFailure() {
             challengeUI.classList.add('hidden');
             resultUI.classList.remove('hidden');
             failureMessage.classList.remove('hidden');
        }

        function resetUI() {
            startButton.classList.remove('hidden');
            recordButton.classList.add('hidden');
            recordButton.disabled = false;
            recordButton.textContent = 'Start Recording';
            challengeUI.classList.add('hidden');
            resultUI.classList.add('hidden');
            successMessage.classList.add('hidden');
            failureMessage.classList.add('hidden');
            statusContainer.classList.remove('hidden');
            loader.classList.add('hidden');
            statusDot.className = 'status-dot pending';
            statusText.textContent = 'Awaiting user action...';
            instructionText.textContent = '';
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', async () => {
            startButton.disabled = true;
            startButton.textContent = 'Initializing Camera...';
            const cameraReady = await setupCamera();
            if (cameraReady) {
                startVerification();
            }
            startButton.disabled = false;
            startButton.textContent = 'Start Verification';
        });

        recordButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        retryButton.addEventListener('click', () => {
            resetUI();
            startVerification();
        });

    </script>
</body>
</html>

